<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Журнали</title>

    <link rel="stylesheet" type="text/css" href="/css/global-style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="/js/JS.js"></script>
    <style type="text/css">
       table {
           border-collapse: collapse;
           width: 40%;
           margin: 20px auto;
       }

       .mark,.dateCell {
           text-align: center;
           padding: 8px;
       }

        #markPick{
            margin: auto;
            width: 40%;
        }

        select{
            display: inline-block;
        }

       #table_mark{
           width: 100%;
           display: block;
           overflow-x: auto;
           white-space: nowrap;
        }

       #table_mark thead th,#table_home thead th{
            border: 2px solid #ffffff;
            background-color: #343A40;
            color:white;
        }
       #table_mark td,#table_home td{
           background-color: #ffffff;
       }

       td,th{
           border: 2px solid #ddd;
           background-color: #ffffff;
       }
    </style>
</head>
<body>
<div class="wrapper">
    <div class="teacher-sidebar" style="float:left;overflow: hidden"></div>

    <div class="container-fluid" style="padding-left: 0px; padding-right: 0px;float: left;overflow: hidden">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark d-flex justify-content-between" style="height: 78px">
            <span class="navbar-text">Ви увійшли як Вчитель</span>
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link" href="/">Вийти</a>
                </li>
            </ul>
        </nav>

        <div class="container-fluid">

            <table class="table" id="description">
                <thead>
                    <tr>
                        <th class="col-4 text-center" id="classTitle">Клас: </th>
                        <th class="col-4 text-center" id="subjectTitle">Предмет: </th>
                        <th class="col-4 text-center" id="yearTitle">Навчальний рік: </th>
                    </tr>
                </thead>
            </table>

            <div class="container-fluid">
                <div class="row justify-content-center" >
                    <table class="table" id="table_mark" style="margin: 0 auto" >
                    </table>
                </div>
            </div>

            <div class="container" id="markPick">
                   <div id="les">
                        Урок: <span id="spanLesson"></span>
                    </div>
            </div>

            <div class="container">
                <table class="table table-bordered" id="table_home">
                    <thead>
                        <tr class="d-flex">
                            <th class="col-3">Дата</th>
                            <th class="col-6">Домашнє завдання</th>
                            <th class="col-3">Файл</th>
                        </tr>
                    </thead>
                </table>
            </div>

            <div class="popover-content hide" style="display: none" >
                    <div class="form-group">
                        <label class="control-label">Оцінка</label>
                        <select id="mark_form">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label >Нотатка</label>
                        <textarea class="form-control" id="note_form" rows="3"></textarea>
                    </div>
                    <button type="button" id="test" class="btn btn-primary">Зберегти</button>
            </div>
        </div>
    </div>
</div>

    <script type="text/javascript">
    $(document).ready(function () {

        var pathArray = window.location.pathname.split('/');
        var idSubject = pathArray[3];
        var idClass = pathArray[5];
        var currentCell;
        var currentIdStudent;
        var currentIdLesson;

        $.getJSON(host + 'classes/'+idClass, function (data) {
          $('<span>'+data.className+'</span>').appendTo('#classTitle');
        });

        $.getJSON(host + 'subjects/'+idSubject, function (data) {
          $('<span>'+data.subjectName+'</span>').appendTo('#subjectTitle');
        });

        $.getJSON(host + 'homeworks/subjects/'+idSubject+'/classes/'+idClass, function (data) {
            var tableBody = $('<tbody></tbody>');
          $.each(data, function(key, val) {
                var tr=$('<tr class="d-flex"></tr>');
                $('<td class="col-3">'+val.date+'</td>').appendTo(tr);
                $('<td class="col-6">'+val.homework+'</td>').appendTo(tr);
                /*$('<td>'+atob(val.file)+'</td>').appendTo(tr);*/
                $('<td class="col-3">'+'file.txt'+'</td>').appendTo(tr);
                tr.appendTo(tableBody);
            });
          tableBody.appendTo("#table_home");
        });
        $.getJSON(host + 'journals/subjects/'+idSubject+'/classes/'+idClass, function (data) {
            var date = data[0].marks[0].dateMark.split(".");
            $('<span>'+date[0]+'</span>').appendTo('#yearTitle');
            $.each(data, function(key, val) {
                var thead=$('<thead ></thead>');
                var tr1=$('<tr></tr>');
                var tr2=$('<tr></tr>');
                $('<th>'+"Тип оцінки"+'</th>').appendTo(tr1);
                $('<th>'+"Дата"+'</th>').appendTo(tr2);
                $.each(val.marks, function(k, v) {
                    var th = $('<th></th>');
                    var select = $('<select class="type"></select>').attr("idLes",v.idLesson);

                    if(v.typeMark=="Control") {
                        $('<option value="Control" selected>' + "Cn." + '</option>').appendTo(select);
                    }
                    else {
                        $('<option value="Control">' + "Cn." + '</option>').appendTo(select);
                    }
                    if(v.typeMark=="Practic") {
                        $('<option value="Practic" selected>' + "Pr." + '</option>').appendTo(select);
                    }
                    else {
                        $('<option value="Practic">' + "Pr." + '</option>').appendTo(select);
                    }
                    if(v.typeMark=="Module") {
                        $('<option value="Module" selected>' + "Md." + '</option>').appendTo(select);
                    }
                    else {
                        $('<option value="Module">' + "Md." + '</option>').appendTo(select);
                    }
                    if(v.typeMark=="Labaratorna") {
                        $('<option value="Labaratorna" selected>' + "Lb." + '</option>').appendTo(select);
                    }
                    else {
                        $('<option value="Labaratorna">' + "Lb." + '</option>').appendTo(select);
                    }
                    select.appendTo(th);
                    th.appendTo(tr1);
                    var date = v.dateMark.split(".");
                    $('<th class="dateCell">'+date[1]+'.'+date[2]+'</th>').appendTo(tr2);
                });
                $('<th>'+'С.'+'</th>').appendTo(tr2);
                tr1.appendTo(thead);
                tr2.appendTo(thead);
                thead.appendTo("#table_mark");
                return false;
            });
            var countStudents = 0;
            $.each(data, function(key, val) {
                var tr=$('<tr class="markValues"></tr>');
                $('<td>'+(++countStudents)+"."+val.studentFullName+'</td>').appendTo(tr);
                $.each(val.marks, function(k, v) {
                    if(!v.mark){
                        $('<td class="mark" data-toggle="popover" >'+""+'</td>').attr("idSt",val.idStudent).attr("idLes",v.idLesson).attr("note",v.note).appendTo(tr);
                    }
                    else {
                        $('<td class="mark" title="'+v.note+'" data-toggle="popover" >' + v.mark + '</td>').attr("idSt",val.idStudent).attr("idLes",v.idLesson).attr("note",v.note).appendTo(tr);
                    }
                });
                $('<td class="average">'+' '+'</td>').appendTo(tr);
                tr.appendTo('#table_mark');
                $('[data-toggle="popover"]').popover({
                    html : true,
                    container: 'body',
                    content: function() {
                        currentIdStudent = $(this).attr("idSt");
                        currentIdLesson = $(this).attr("idLes");
                        var anchorText = $(this).text();
                        $('.popover-content').find('input[id=txtContent]').attr('value', anchorText);
                        $(".popover-content textarea#note_form").val(anchorText);
                        return $(".popover-content").html();
                    }
                });

                $('body').on('click', function (e) {
                    $('[data-toggle=popover]').each(function () {
                        // hide any open popovers when the anywhere else in the body is clicked
                        if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0) {
                            $(this).popover('hide');
                        }
                    });
                });


            });
            averageMark();
            $('td.mark').click(markClick);
            $("select.type").change(dropClick);
        });

        $(document).on('click', '#test', function(){
            var mark = $(".popover #mark_form").val();
            var note = $(".popover #note_form").val();
            alert(currentCell+" aaa")

            $.ajax({
                type: "post",
                url: host + "marks",
                dataType: "json",
                data: JSON.stringify({
                    "mark": mark,
                    "note": note,
                    "idStudent":  currentCell.attr("idSt"),
                    "idLesson":  currentCell.attr("idLes")
                }),
                contentType: "application/json",
                success: function (response) {
                    currentCell.text(mark);
                    currentCell.prop("note",note);
                    averageMark();
                    $(".popover textarea#note_form").val(note);
                    currentCell.popover('hide');
                    currentCell.css("background-color", "");
                }
            });

        });


        function averageMark() {
            $('#table_mark .markValues').each(function () {
                var sum = 0;
                var total = 0;
                var average = "";
                $(this).find('.mark').each(function () {
                    if ($(this).text()) {
                        total += 1;
                        sum += parseInt($(this).text());
                    }
                });
                if (total != 0) {
                    average = (sum / total).toFixed(2);
                }
                $(this).find('.average').text(average);
            });
        }

        function markClick(){
            if(currentCell != undefined && (currentCell.attr("idSt")==$(this).attr("idSt") && currentCell.attr("idLes")==$(this).attr("idLes"))){
                alert('1');
                currentCell.css("background-color", "");
                currentCell = undefined;
            }
            else if( currentCell != undefined && currentCell.attr("idSt")!=$(this).attr("idSt") && currentCell.attr("idLes")!=$(this).attr("idLes")){
                alert('2');
                currentCell.css("background-color", "");
                $(this).css("background-color", "#83AF86");
                currentCell = $(this);
            }
            else {
                alert('3');
                currentCell = $(this);
                $(this).css("background-color", "#83AF86");
            }
        }

        function dropClick() {
            $.ajax({
                type: "put",
                url: host + "marks/lessons/"+$(this).attr("idLes")+"/marktype",
                dataType: "json",
                data: JSON.stringify({
                    "markType": $(this).val()
                }),
                contentType: "application/json",
                success: function (response) {
                    alert("success");
                }
            });
        }

    });
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script type="text/javascript">
        $(function() {
            $(".teacher-sidebar").load("/views/teacher-sidebar.html");
        });
    </script>
</body>
</html>