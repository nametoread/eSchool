<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Журнали</title>

    <style type="text/css">
       .description{
           font-family: Garamond;
           font-size: 22px;
           margin-left: 25%;
           width: 500px;
           padding: 20px;
       }
       table,td,th{
           border: 1px solid #ddd;
       }
       table {
           border-collapse: collapse;
           width: 40%;
           margin: 20px auto;
       }

       th, td {
           text-align: left;
           padding: 8px;
       }

       .header{
           color: white;
           height: 50px;
           background: #4CAF50;
           border: solid 1px black;
       }

       .header a{
           color:white;
       }

       tr:nth-child(even){background-color: #f2f2f2}

       th {
           background-color: #4CAF50;
           color: white;
       }

        #markPick{
            margin: auto;
            width: 40%;
        }

        select{
            display: inline-block;
        }

       #table_mark{
           width: 100%;
           display: block;
           overflow-x: auto;
           white-space: nowrap;
        }

    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="/js/JS.js"></script>
</head>
<body>
<div class="header">
    <span style="float: right; margin-right: 10px; margin-top: 15px"><a href="/teachers/1/profile">Домашня сторінка</a></span>
    <span style="float: left; margin-left: 10px; margin-top: 15px" id="loggeduser">Ви увійшли як Teacher01</span>
    <span style="float: left; margin-left: 35%; margin-top: 15px" id="status"> Статус: Вчитель</span>
    <span style="float: right; margin-right: 10px; margin-top: 15px"><a href="#" onclick="logOut()"> Вийти</a></span>
</div>

    <div class="description" id="classTitle">Клас: </div>
    <div class="description" id="subjectTitle">Предмет: </div>

    <table id="table_mark">

    </table>

<div id="markPick">
    <div id="st">
        Студент: <span id="spanStudent"></span>
    </div>
    <div id="les">
        Урок: <span id="spanLesson"></span>
    </div>
    <form id="formInput">
        Mark: <input type="number" id="mark_form" min="1" max="12"><br>
        Note:<input type="text" id="note_form"><br><br>
        <input type="submit" value="Submit">
    </form>
</div>

<table id="table_home">
        <tr>
            <th>Дата</th>
            <th>Домашнє завдання</th>
            <th>Файл</th>
        </tr>
    </table>


    <script type="text/javascript">
        $(document).ready(function () {
            refreshToken();
            $.ajaxSetup({
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " +localStorage.getItem("jwtToken"))
                }
            })
        })

    $(document).ready(function () {

        var pathArray = window.location.pathname.split('/');
        var idSubject = pathArray[3];
        var idClass = pathArray[5];
        var currentCell;


        $.getJSON(host + 'classes/'+idClass, function (data) {
          $('<span>'+data.className+'</span>').appendTo('#classTitle');
        });

        $.getJSON(host + 'subjects/'+idSubject, function (data) {
          $('<span>'+data.subjectName+'</span>').appendTo('#subjectTitle');
        });

        $.getJSON(host + 'homeworks/subjects/'+idSubject+'/classes/'+idClass, function (data) {
          $.each(data, function(key, val) {
                var tr=$('<tr></tr>');
                $('<td>'+val.date+'</td>').appendTo(tr);
                $('<td>'+val.homework+'</td>').appendTo(tr);
                /*$('<td>'+atob(val.file)+'</td>').appendTo(tr);*/
                $('<td>'+'file.txt'+'</td>').appendTo(tr);
                tr.appendTo('#table_home');
            });
        });

        $.getJSON(host + 'journals/subjects/'+idSubject+'/classes/'+idClass, function (data) {
            $.each(data, function(key, val) {
                var tr1=$('<tr></tr>');
                var tr2=$('<tr></tr>');
                $('<th>'+"Тип оцінки"+'</th>').appendTo(tr1);
                $('<th>'+"Дата"+'</th>').appendTo(tr2);
                $.each(val.marks, function(k, v) {
                    //$('<th >'+v.typeMark+'</th>').appendTo(tr1);
                    var th = $('<th></th>');
                    var select = $('<select class="type"></select>').attr("idLes",v.idLesson);

                    if(v.typeMark=="Control") {
                        $('<option value="Control" selected>' + "Control" + '</option>').appendTo(select);
                    }
                    else {
                        $('<option value="Control">' + "Control" + '</option>').appendTo(select);
                    }
                    if(v.typeMark=="Practic") {
                        $('<option value="Practic" selected>' + "Practic" + '</option>').appendTo(select);
                    }
                    else {
                        $('<option value="Practic">' + "Practic" + '</option>').appendTo(select);
                    }
                    if(v.typeMark=="Module") {
                        $('<option value="Module" selected>' + "Module" + '</option>').appendTo(select);
                    }
                    else {
                        $('<option value="Module">' + "Module" + '</option>').appendTo(select);
                    }
                    if(v.typeMark=="Labaratorna") {
                        $('<option value="Labaratorna" selected>' + "Labaratorna" + '</option>').appendTo(select);
                    }
                    else {
                        $('<option value="Labaratorna">' + "Labaratorna" + '</option>').appendTo(select);
                    }
                    select.appendTo(th);

                    th.appendTo(tr1);
                    $('<th>'+v.dateMark+'</th>').appendTo(tr2);
                });
                $('<th>'+'С.'+'</th>').appendTo(tr2);
                tr1.appendTo('#table_mark');
                tr2.appendTo('#table_mark');
                return false;
            });
            var countStudents = 0;
            $.each(data, function(key, val) {
                var tr=$('<tr class="markValues"></tr>');
                $('<td>'+(++countStudents)+"."+val.studentFullName+'</td>').appendTo(tr);
                $.each(val.marks, function(k, v) {
                    if(!v.mark){
                        $('<td class="mark">'+""+'</td>').attr("idSt",val.idStudent).attr("idLes",v.idLesson).appendTo(tr);
                    }
                    else {
                        $('<td class="mark" title="'+v.note+'">' + v.mark + '</td>').attr("idSt",val.idStudent).attr("idLes",v.idLesson).appendTo(tr);
                    }
                });
                $('<td class="average">'+' '+'</td>').appendTo(tr);
                tr.appendTo('#table_mark');
            });
            averageMark();
            $('td.mark').click(markClick);
            $("select.type").change(dropClick);
        });


        $('form').on('submit', function (e) {
            e.preventDefault();
            var mark = $("#mark_form").val();
            var note = $("#note_form").val();

            if(currentCell==undefined){
                alert("Не вибрано клітинки");
                return;
            }
            if(mark<1 || mark>12){
                alert("Неправильна оцінка");
                return;
            }
            $.ajax({
                type: "post",
                url: host + "marks",
                dataType: "json",
                data: JSON.stringify({
                    "mark": mark,
                    "note": note,
                    "idStudent":  currentCell.attr("idSt"),
                    "idLesson":  currentCell.attr("idLes")
                }),
                contentType: "application/json",
                success: function (response) {
                    currentCell.text(mark);
                    currentCell.prop("title",note);
                    averageMark();
                }
            });
        })

        function averageMark() {
            $('#table_mark .markValues').each(function () {
                var sum = 0;
                var total = 0;
                var average = "";
                $(this).find('.mark').each(function () {
                    if ($(this).text()) {
                        total += 1;
                        sum += parseInt($(this).text());
                    }
                });
                if (total != 0) {
                    average = (sum / total).toFixed(2);
                }
                $(this).find('.average').text(average);
            });
        }

        function markClick(){
            if(currentCell != undefined && (currentCell.attr("idSt")==$(this).attr("idSt") && currentCell.attr("idLes")==$(this).attr("idLes"))){
                currentCell.css("background-color", "");
                $('#spanStudent').text("");
                $('#spanLesson').text("");
                currentCell = undefined;
            }
            else {
                if (currentCell != undefined) {
                    currentCell.css("background-color", "");
                }
                var idS = $(this).attr("idSt");
                var idL = $(this).attr("idLes");
                $('#spanStudent').text(idS);
                $('#spanLesson').text(idL);
                $('#note_form').val($(this).attr("title"));
                $('#mark_form').val($(this).text());
                currentCell = $(this);
                $(this).css("background-color", "#83AF86");
            }
        }

        function dropClick() {
            $.ajax({
                type: "put",
                url: host + "marks/lessons/"+$(this).attr("idLes")+"/marktype",
                dataType: "json",
                data: JSON.stringify({
                    "markType": $(this).val(),
                }),
                contentType: "application/json",
                success: function (response) {
                    alert("success");
                }
            });
            console.log($(this).attr("idLes")+" "+$(this).val());
        }

    });
    </script>
</body>
</html>