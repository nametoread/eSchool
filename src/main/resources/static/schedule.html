<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" href="/css/global-style.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.min.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.2/css/all.css" integrity="sha384-/rXc/GQVaYpyDdyxK+ecHPVYJSN9bmVFBvjA/9eOB+pb3F2w2N6fc5qB9Ew5yIns" crossorigin="anonymous">
<!-- CSS -->
<style type="text/css">
.nowrap {
  white-space: nowrap ;
}
.error {
    color: red;
}
select {
   -webkit-appearance: button;
   -webkit-border-radius: 2px;
   -webkit-box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1);
   -webkit-padding-end: 20px;
   -webkit-padding-start: 2px;
   -webkit-user-select: none;
   background-image: url(http://i62.tinypic.com/15xvbd5.png), -webkit-linear-gradient(#FAFAFA, #F4F4F4 40%, #E5E5E5);
   background-position: 97% center;
   background-repeat: no-repeat;
   border: 1px solid #AAA;
   color: #555;
   font-size: inherit;
   margin-bottom: 8px;
   overflow: hidden;
   padding: 5px 10px;
   text-overflow: ellipsis;
   white-space: nowrap;
   width: 250px;
 }
</style>
<head>
    <title>Schedule</title>
    <script src="/js/JS.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-md navbar-dark fixed-top justify-content-between" style="background-color: #002c4c !important;"></nav>
<div class="row" id="body-row">
    <div id="sidebar-container" class="sidebar-expanded d-none d-md-block col-2.5"></div>
    <div class="col py-3">
        <div class="container">
            <div id="message" align="center"></div>
            <div id="u1" align="center" style="padding-bottom:10px; padding-top:10px">
                <p><h1><span>Внесення розкладу</span></h1></p>
            </div>
            <div class="row">
                <div class="col">
                    <div class="main">

                        <div class="container">
                            <form id = "myForm">
                                <div class="row">


                                    <div class="col">
                                        <p for="start"  class="control-label col-4 requiredField font-weight-bold nowrap" style="padding-top:25px">Введіть початок семетру:<span class="asteriskField">*</span></p>
                                        <div class="controls col-8">
                                            <input class="input-md form-control" id="start" type="date" name="startDate" style="width:200px">
                                        </div>
                                    </div>

                                    <div class="col">
                                        <p for="end"  class="control-label col-4 requiredField font-weight-bold nowrap" style="padding-top:25px">Введіть кінець семетру:<span class="asteriskField">*</span></p>
                                        <div class="controls col-8">
                                            <input class="input-md form-control" id="end" type="date" name="endDate" style="width:200px">
                                        </div>
                                    </div>



                                    <div class="col">
                                        <p for="u15_input" class="control-label col-4 requiredField font-weight-bold nowrap" style="padding-top:25px">Виберіть клас:<span class="asteriskField">*</span></p>
                                        <div class="controls col-8">
                                            <select id="u15_input" style="width:200px">
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="container" style="padding-top:20px">
                            <div class="row">
                                <div class="col">
                                    <p>Понеділок</p>
                                    <ol id="monday">
                                        <div class="controls1">
                                            <form role="form" autocomplete="off">
                                                <div class="entry input-group col-xs-3">
                                                    <div class="row">
                                                    <li>
                                                        <select name="monday" class="ax_default_droplist1" data-type="answer" class="select">
                                                            <option value="0">-</option>
                                                        </select>

                                                        <span class="input-group-btn">
                            <button class="btn btn-success btn-add" type="button">
                                <span> + </span>
                            </button>
                        </span>
                                                    </li>
                                                    </div>

                                                </div>
                                            </form>
                                        </div>
                                    </ol>
                                </div>

                                <div class="col">
                                    <p>Четвер</p>
                                    <ol id="thursday">
                                        <div class="controls4">
                                            <form role="form" autocomplete="off">
                                                <div class="entry input-group col-xs-3">
                                                    <div class="row">
                                                    <li>
                                                        <select name="thursday" class="ax_default_droplist4" data-type="answer" class="select">
                                                            <option value="0">-</option>
                                                        </select>

                                                        <span class="input-group-btn">
                            <button class="btn btn-success btn-add" type="button">
                                <span> + </span>
                            </button>
                        </span>
                                                    </li>
                                                    </div>

                                                </div>
                                            </form>
                                        </div>
                                    </ol>
                                </div>
                            </div>


                            <div class="row">
                                <div class="col">
                                    <p>Вівторок</p>
                                    <ol id="tuesday">
                                        <div class="controls2">
                                            <form role="form" autocomplete="off">
                                                <div class="entry input-group col-xs-3">
                                                    <div class="row">
                                                    <li>
                                                        <select name="tuesday" class="ax_default_droplist2" data-type="answer" class="select">
                                                            <option value="0">-</option>
                                                        </select>

                                                        <span class="input-group-btn">
                            <button class="btn btn-success btn-add" type="button">
                                <span> + </span>
                            </button>
                        </span>
                                                    </li>
                                                    </div>

                                                </div>
                                            </form>
                                        </div>
                                    </ol>
                                </div>

                                <div class="col">
                                    <p>П'ятниця</p>
                                    <ol id="friday">
                                        <div class="controls5">
                                            <form role="form" autocomplete="off">
                                                <div class="entry input-group col-xs-3">
                                                    <div class="row">
                                                    <li>
                                                        <select name="friday" class="ax_default_droplist5" data-type="answer" class="select">
                                                            <option value="0">-</option>
                                                        </select>

                                                        <span class="input-group-btn">
                            <button class="btn btn-success btn-add" type="button">
                                <span> + </span>
                            </button>
                        </span>
                                                    </li>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </ol>
                                </div>
                            </div>


                            <div class="row">
                                <div class="col">
                                    <p>Середа</p>
                                    <ol id="wednesday">
                                        <div class="controls3">
                                            <form role="form" autocomplete="off">
                                                <div class="entry input-group col-xs-3">
                                                    <div class="row">
                                                    <li>
                                                        <select name="wednesday" class="ax_default_droplist3" data-type="answer" class="select">
                                                            <option value="0">-</option>
                                                        </select>

                                                        <span class="input-group-btn">
                            <button class="btn btn-success btn-add" type="button">
                                <span> + </span>
                            </button>
                        </span>
                                                    </li>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <div id="u17" align="center" style="text-align: center; margin: 0 auto; padding-top: 25px; padding-bottom: 100px">
                            <button id="submitButton" class="btn btn-success" type="submit">Створити розклад</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
/****************************************Add more selects*********************************************************************/
function addMore(obj, controls)
{
      $(obj).on('click', '.btn-add', function(e)
    {
        e.preventDefault();
        var controlForm = $(controls + ' form:first'),
            currentEntry = $(this).parents('.entry:first'),
            newEntry = $(currentEntry.clone()).appendTo(controlForm);
        var id = 0;
        newEntry.each(function(){
                   $(this).find('select').attr('id', id + 1);
                });
        controlForm.find('.entry:not(:last) .btn-add')
            .removeClass('btn-add').addClass('btn-remove')
            .removeClass('btn-success').addClass('btn-danger')
            .html('<span> - </span>');
    }).on('click', '.btn-remove', function(e)
    {
        $(this).parents('.entry:first').remove();
        e.preventDefault();
        return false;
    });
}
$(function()
{
  addMore('#monday', '.controls1');
  addMore('#tuesday', '.controls2');
  addMore('#wednesday', '.controls3');
  addMore('#thursday', '.controls4');
  addMore('#friday', '.controls5');
});
/****************************************Security*********************************************************************/
    $(document).ready(function () {
        refreshToken();
        $.ajaxSetup({
            beforeSend: function (xhr) {
                if (getJwtToken()) {
                    xhr.setRequestHeader("Authorization", localStorage.getItem("jwtToken"))
                }
            }
        })
    })
/****************************************Valdation of forms*********************************************************************/
        <!--var markDates = [];-->
           <!--$.getJSON(host + 'marksDescription', function(data){-->
                    <!--$.each(data.data, function(key, value) {-->
                            <!--markDates.push(value.dateMark);-->
                    <!--});-->
                <!--}).fail(function (data) {-->
                <!--if (new RegExp("4[0-9][0-9]").test(data.status)){-->
                    <!--window.location.href='/ui/login'-->
                <!--}-->
            <!--});-->
        $(document).ready(function() {
            var today = new Date();
            var one_day_ago=new Date().setDate(today.getDate()-1);
            var dd = today.getDate();
            var mm = today.getMonth()+1; //January is 0!
            var yyyy = today.getFullYear();
             if(dd<10){
                    dd='0'+dd
                }
                if(mm<10){
                    mm='0'+mm
                }
            today = yyyy+'-'+mm+'-'+dd;

           jQuery.validator.addMethod("minDate", function(value, element) {
                 var inputDate = new Date(value);
                  if (inputDate > one_day_ago)
                      return true;
                  return false;
          }, "Дата повинна бути більшою чи рівною " + today);

          <!--jQuery.validator.addMethod("markDate", function(value, element) {-->
                 <!--var inputDate = new Date(value);-->
                 <!--for (var i = 0; i < markDates.length; i ++){-->
                  <!--if (inputDate != new Date(markDates[i]))-->
                      <!--return true;-->
                   <!--}-->
                  <!--return false;-->
          <!--}, "За цю дату уже виставлені оцінки");-->

          jQuery.validator.addMethod("endOfDate", function(value, element) {
            var startdatevalue = $("#start").val();
            if (new Date(startdatevalue) < new Date(value))
                      return true;
                  return false;
            }, "Дата кінця семетру повинна бути більшою чим дата початку семестру");

          $("#myForm").validate({
            rules: {
                startDate: {
                    required: true,
                    date: true,
                    minDate: true,
                    <!--markDate: true-->
                },
                endDate: {
                    required: true,
                    date: true,
                    endOfDate: true,
                    <!--markDate: true-->
                }
            },
            messages: {
             startDate: {
                    required: "Це поле обов'язкове"
                },
             endDate: {
                    required: "Це поле обов'язкове"
                }
            }
        });
/****************************************Get subjects and classes from endpoints*********************************************************************/
            $.getJSON(host + 'subjects', function (data) {
                var subjectNames = [];
                var id = [];
                $.each(data.data, function(key, value) {
                        subjectNames.push(value.subjectName);
                        id.push(value.subjectId);
                    });
                for (i=0; i < subjectNames.length; i++)
                {
                    $('.ax_default_droplist1').append('<option value="' + id[i] + '"name="monday">' + subjectNames[i] + '</option>');
                    $('.ax_default_droplist2').append('<option value="' + id[i] + '"name="tuesday">' + subjectNames[i] + '</option>');
                    $('.ax_default_droplist3').append('<option value="' + id[i] + '"name="wednesday">' + subjectNames[i] + '</option>');
                    $('.ax_default_droplist4').append('<option value="' + id[i] + '"name="thursday">' + subjectNames[i] + '</option>');
                    $('.ax_default_droplist5').append('<option value="' + id[i] + '"name="friday">' + subjectNames[i] + '</option>');
                }
                if (subjectNames.length == 0)
                    {
                    $("#message").attr("class", "alert alert-danger");
                    $("#message").html("<strong>Ще не створено предметів. Ви не можете створити розклад.</strong>");
                    }
            }).fail(function (data) {
                if (new RegExp("4[0-9][0-9]").test(data.status)){
                    window.location.href='/ui/login'
                }
            });
            $.getJSON(host + 'classes', function(data){
                    var classNames = [];
                    var id = [];
                    $.each(data.data, function(key, value) {
                        if (value.isActive == true) {
                            classNames.push(value.className);
                            id.push(value.id);
                        }
                    });
                    for (i=0; i < classNames.length; i++)
                        $('#u15_input').append('<option value="' + id[i] + '">' + classNames[i] + '</option>');
                     if (classNames.length == 0)
                    {
                    $("#message").attr("class", "alert alert-danger");
                    $("#message").html("<strong>Ще не створено класи, або всі класи є неактивними. Ви не можете створити розклад.</strong>");
                    }
                });
/****************************************Save data when clicking on the submitButton*********************************************************************/
            $('#submitButton').click(function(){
                var startdate = $('#start').val();
                var enddate = $('#end').val();
                var classObj = {id: $('#u15_input').find(":selected").val(), classYear: (new Date()).getFullYear(),
                className: $("#u15_input").find('option:selected').text(), classDescription: " ", isActive: "true"};
                classId = $('#u15_input').find(":selected").val();
                var monday = [];
                var tuesday = [];
                var wednesday = [];
                var thursday = [];
                var friday = [];
                  $('select > option:selected').each(function() {
                   if($(this).attr('name') == 'monday')
                   monday.push({subjectId: $(this).val(), subjectName: $(this).text(), subjectDescription: ""});
                   if($(this).attr('name') == 'tuesday')
                   tuesday.push({subjectId: $(this).val(), subjectName: $(this).text(), subjectDescription: ""});
                   if($(this).attr('name') == 'wednesday')
                   wednesday.push({subjectId: $(this).val(), subjectName: $(this).text(), subjectDescription: ""});
                   if($(this).attr('name') == 'thursday')
                   thursday.push({subjectId: $(this).val(), subjectName: $(this).text(), subjectDescription: ""});
                   if($(this).attr('name') == 'friday')
                   friday.push({subjectId: $(this).val(), subjectName: $(this).text(), subjectDescription: ""});
                  });
                function deleteFromArray(array)
                {
                  var array2 = [];
                  for (i=0; i<array.length; i++){
                    if (array[i].subjectId != 0) { array2.push(array[i]);}
                    }
                   return array2;
                }
                $.ajax({
                type: "post",
                url: host + "classes/" + classId + "/schedule",
                dataType: "json",
                data: JSON.stringify({
                  "startOfSemester":startdate,
                  "endOfSemester":enddate,
                  "className":classObj,
                  "mondaySubjects":deleteFromArray(monday),
                  "tuesdaySubjects":deleteFromArray(tuesday),
                  "wednesdaySubjects":deleteFromArray(wednesday),
                  "thursdaySubjects":deleteFromArray(thursday),
                  "fridaySubjects":deleteFromArray(friday)
                }),
                contentType: "application/json",
                    statusCode: {
                       200: function() {
                        $("#message").attr("class", "alert alert-success");
                        $("#message").html("<strong>Розклад успішно створений</strong>");
                    },
                      201: function() {
                      $("#message").attr("class", "alert alert-success");
                      $("#message").html("<strong>Розклад успішно створений</strong>");
                    },
                    400: function() {
                        $("#message").attr("class", "alert alert-danger");
                        $("#message").html("<strong>Такий розклад уже існує, та оцінки за ці дати виставлені</strong> <br>Неможливо створити розклад з межами " + startdate + " - " + enddate + "</br>");
                    },
                      500: function() {
                      $("#message").attr("class", "alert alert-danger");
                      $("#message").html("<strong>Внутрішня помилка сервера</strong>");
                    }
                  },
                    success: function (responce) {
                        $("#start").val("");
                        $("#end").val("");
                        $('.controls1').find('.entry:not(:last)').remove();
                        $('.controls2').find('.entry:not(:last)').remove();
                        $('.controls3').find('.entry:not(:last)').remove();
                        $('.controls4').find('.entry:not(:last)').remove();
                        $('.controls5').find('.entry:not(:last)').remove();
                        $('select').val("0");
                        $('#u15_input').val($('#u15_input option:first').val());
                    }
            });
        })
    })
    </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script type="text/javascript">
    $(function() {
        $("#sidebar-container").load("/views/admin-sidebar.html");
        $(".navbar").load("/views/admin-header.html");
    });
</script>
</body>
</html>